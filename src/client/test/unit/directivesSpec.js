var sample_data = {
    "_id": {
        "$oid": "51704a732e7b36a8e55400a5"
    },
    "docVersion": 1,
    "id": "ProgressiveTest",
    "titleSection": {
        "name": "Progessive Test Data",
        "shortDescription": "This is a test entry for use during development.",
        "pricing": "Free",
        "support": {
            "text": "VersionOne Support",
            "href": "http://support.versionone.com/home"
        }
    },
    "descriptionSection": {
        "description": "<script evilStuff>Lorem</script> <p>ipsum dolor sit amet</p>, **consectetuer adipiscing elit**, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volu. Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volu. Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volu. Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volu. Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volu. Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volu. Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volu. Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volu. Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volu. Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volu. Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volu. Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volu. Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volu. Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volu."
    },
    "linksSection": [
        {
            "_id": "516d9a4824a05b20580000a7",
            "type": "download",
            "href": "http://platform.versionone.com.s3.amazonaws.com/downloads/v1clarityppm_0.3.2.13.zip",
            "title": "Download Latest Stable Release"
        },
        {
            "_id": "516d9a4824a05b20580000a7",
            "type": "download",
            "href": "http://platform.versionone.com.s3.amazonaws.com/downloads/v1clarityppm_0.3.2.13.zip",
            "title": "Download Latest Nightly Build"
        },
        {
            "_id": "516d9a4824a05b20580000a6",
            "type": "code",
            "href": "https://github.com/versionone/V1ClarityPPM",
            "title": "Source Code"
        },
        {
            "_id": "516d9a4824a05b20580000a5",
            "type": "documentation",
            "href": "https://github.com/versionone/V1ClarityPPM/blob/master/README.md",
            "title": "Documentation"
        },
        {
            "_id": "516d9a4824a05b20580000a4",
            "type": "license",
            "href": "https://github.com/versionone/V1ClarityPPM/blob/master/LICENSE.md",
            "title": "Modified BSD (3-clause) License"
        },
        {
            "_id": "516d9a4824a05b20580000a3",
            "type": "foo",
            "href": "https://github.com/versionone/V1ClarityPPM/blob/master",
            "title": "Sample configuration"
        }
    ],
 "updatesSection": {
        "updates": [
            {
                "date": "2013-01-13T17:45:00.000Z",
                "description": "better timesheet support",
                "version": "c",
                "releaseNotes": "http://example.com",
                "qualityBand": "sapling",
                "downloadUrl": "http://platform.versionone.com.s3.amazonaws.com/downloads/v1clarityppm_0.2.1.10.zip",
                "_id": {
                    "$oid": "516d9a4824a05b2058000099"
                }
            },
            {
                "date": "2013-02-13T17:45:00.000Z",
                "description": "stabilizing timesheet workflow",
                "version": "b",
                "releaseNotes": "http://example.com",
                "qualityBand": "mature",
                "downloadUrl": "http://platform.versionone.com.s3.amazonaws.com/downloads/v1clarityppm_0.3.2.13.zip",
                "_id": {
                    "$oid": "516d9a4824a05b205800009a"
                }
            },
            {
                "date": "2013-01-10T17:45:00.000Z",
                "description": "better timesheet support",
                "version": "a",
                "releaseNotes": "http://example.com",
                "qualityBand": "sapling",
                "downloadUrl": "http://platform.versionone.com.s3.amazonaws.com/downloads/v1clarityppm_0.2.1.10.zip",
                "_id": {
                    "$oid": "516d9a4824a05b2058000099"
                }
            },
            {
                "date": "2010-01-13T17:45:00.000Z",
                "description": "better timesheet support",
                "version": "c",
                "releaseNotes": "http://example.com",
                "qualityBand": "sapling",
                "downloadUrl": "http://platform.versionone.com.s3.amazonaws.com/downloads/v1clarityppm_0.2.1.10.zip",
                "_id": {
                    "$oid": "516d9a4824a05b2058000099"
                }
            },
            {
                "date": "2010-02-13T17:45:00.000Z",
                "description": "stabilizing timesheet workflow",
                "version": "b",
                "releaseNotes": "http://example.com",
                "qualityBand": "mature",
                "downloadUrl": "http://platform.versionone.com.s3.amazonaws.com/downloads/v1clarityppm_0.3.2.13.zip",
                "_id": {
                    "$oid": "516d9a4824a05b205800009a"
                }
            },
            {
                "date": "2010-01-10T17:45:00.000Z",
                "description": "better timesheet support",
                "version": "a",
                "releaseNotes": "http://example.com",
                "qualityBand": "sapling",
                "downloadUrl": "http://platform.versionone.com.s3.amazonaws.com/downloads/v1clarityppm_0.2.1.10.zip",
                "_id": {
                    "$oid": "516d9a4824a05b2058000099"
                }
            },
        ],
          "qualityBands": {
            "seed": {
                "name": "seed",
                "shortDesc": "The initial idea of a product. No working code.",
                "href": "https://github.com/versionone/V1ClarityPPM/blob/master/CONTRIBUTING.md#seed",
                "_id": {
                    "$oid": "516d9a4824a05b205800009d"
                }
            },
            "sapling": {
                "name": "sapling",
                "shortDesc": "The product is undergoing rapid growth. The code works but expect major changes.",
                "href": "https://github.com/versionone/V1ClarityPPM/blob/master/CONTRIBUTING.md#sapling",
                "_id": {
                    "$oid": "516d9a4824a05b205800009c"
                }
            },
            "mature": {
                "name": "mature",
                "shortDesc": "The product is stable. The code will continue to evolve with minimum breaking changes.",
                "href": "https://github.com/versionone/V1ClarityPPM/blob/master/CONTRIBUTING.md#mature",
                "_id": {
                    "$oid": "516d9a4824a05b205800009b"
                }
            }
        }
    },
    "mediaSection": [
        {
            "title": "Home",
            "caption": "The home image",
            "mimetype": "image/png",
            "href": "content/gallery/Projekt_es_Projekt_portfolio_menedzsment_ca_clarity_ppm_masolata.jpg",
            "thumbhref": "content/gallery/Projekt_es_Projekt_portfolio_menedzsment_ca_clarity_ppm_masolata.jpg"
        },
        {
            "mimetype": "image/png",
            "href": "content/gallery/ppm-roadmap-large.jpg",
            "thumbhref": "content/gallery/ppm-roadmap-large.jpg"
        },
        {
            "title": "Video",
            "caption": "This ia a video",
            "mimetype": "video/flv",
            "href": "http://www.versionone.tv.s3.amazonaws.com/Clarity/Clarity.flv",
            "thumbhref": "content/gallery/ClaritySplash.png"
        },
        {
            "title": "Junk",
            "caption": "You shouldn't see this!",
            "mimetype": "foo/bar",
            "href": "http://www.versionone.tv.s3.amazonaws.com/Clarity/Clarity.flv",
            "thumbhref": "content/gallery/ClaritySplash.png"
        }

    ]
};

var sample_data_one_slide = {
    "_id": {
        "$oid": "51704a732e7b36a8e55400a5"
    },
    "docVersion": 1,
    "id": "ProgressiveTest",
    "titleSection": {
        "name": "Progessive Test Data",
        "shortDescription": "This is a test entry for use during development.",
        "pricing": "Free",
        "support": {
            "text": "VersionOne Support",
            "href": "http://support.versionone.com/home"
        }
    },
    "descriptionSection": {
        "description": "Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volu. Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volu. Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volu. Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volu. Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volu. Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volu. Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volu. Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volu. Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volu. Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volu. Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volu. Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volu. Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volu. Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volu."
    },
    "linksSection": [
        {
            "_id": "516d9a4824a05b20580000a7",
            "type": "download",
            "href": "http://platform.versionone.com.s3.amazonaws.com/downloads/v1clarityppm_0.3.2.13.zip",
            "title": "Download Latest Stable Release"
        },
        {
            "_id": "516d9a4824a05b20580000a7",
            "type": "download",
            "href": "http://platform.versionone.com.s3.amazonaws.com/downloads/v1clarityppm_0.3.2.13.zip",
            "title": "Download Latest Nightly Build"
        },
        {
            "_id": "516d9a4824a05b20580000a6",
            "type": "code",
            "href": "https://github.com/versionone/V1ClarityPPM",
            "title": "Source Code"
        },
        {
            "_id": "516d9a4824a05b20580000a5",
            "type": "documentation",
            "href": "https://github.com/versionone/V1ClarityPPM/blob/master/README.md",
            "title": "Documentation"
        },
        {
            "_id": "516d9a4824a05b20580000a4",
            "type": "license",
            "href": "https://github.com/versionone/V1ClarityPPM/blob/master/LICENSE.md",
            "title": "Modified BSD (3-clause) License"
        },
        {
            "_id": "516d9a4824a05b20580000a3",
            "type": "foo",
            "href": "https://github.com/versionone/V1ClarityPPM/blob/master",
            "title": "Sample configuration"
        }
    ],
 "updatesSection": {
        "updates": [
            {
                "date": "2013-02-13T17:45:00.000Z",
                "description": "stabilizing timesheet workflow",
                "version": "0.3.2.13",
                "releaseNotes": "http://example.com",
                "qualityBand": "mature",
                "downloadUrl": "http://platform.versionone.com.s3.amazonaws.com/downloads/v1clarityppm_0.3.2.13.zip",
                "_id": {
                    "$oid": "516d9a4824a05b205800009a"
                }
            },
            {
                "date": "2013-01-13T17:45:00.000Z",
                "description": "better timesheet support",
                "version": "0.3.3.5",
                "releaseNotes": "http://example.com",
                "qualityBand": "sapling",
                "downloadUrl": "http://platform.versionone.com.s3.amazonaws.com/downloads/v1clarityppm_0.2.1.10.zip",
                "_id": {
                    "$oid": "516d9a4824a05b2058000099"
                }
            },
            {
                "date": "2013-01-13T17:45:00.000Z",
                "description": "better timesheet support",
                "version": "0.2.1.10",
                "releaseNotes": "http://example.com",
                "qualityBand": "sapling",
                "downloadUrl": "http://platform.versionone.com.s3.amazonaws.com/downloads/v1clarityppm_0.2.1.10.zip",
                "_id": {
                    "$oid": "516d9a4824a05b2058000099"
                }
            }
        ],
          "qualityBands": {
            "seed": {
                "name": "seed",
                "shortDesc": "The initial idea of a product. No working code.",
                "href": "https://github.com/versionone/V1ClarityPPM/blob/master/CONTRIBUTING.md#seed",
                "_id": {
                    "$oid": "516d9a4824a05b205800009d"
                }
            },
            "sapling": {
                "name": "sapling",
                "shortDesc": "The product is undergoing rapid growth. The code works but expect major changes.",
                "href": "https://github.com/versionone/V1ClarityPPM/blob/master/CONTRIBUTING.md#sapling",
                "_id": {
                    "$oid": "516d9a4824a05b205800009c"
                }
            },
            "mature": {
                "name": "mature",
                "shortDesc": "The product is stable. The code will continue to evolve with minimum breaking changes.",
                "href": "https://github.com/versionone/V1ClarityPPM/blob/master/CONTRIBUTING.md#mature",
                "_id": {
                    "$oid": "516d9a4824a05b205800009b"
                }
            }
        }
    },
    "mediaSection": [
        {
            "title": "Home",
            "caption": "The home image",
            "mimetype": "image/png",
            "href": "content/gallery/Projekt_es_Projekt_portfolio_menedzsment_ca_clarity_ppm_masolata.jpg",
            "thumbhref": "content/gallery/Projekt_es_Projekt_portfolio_menedzsment_ca_clarity_ppm_masolata.jpg"
        }
    ]
};

describe('app', function(){
    beforeEach(module('appCatalog'));
    // This is probably best tested via e2e testing?
});

describe('controllers', function() {
    beforeEach(module('appCatalog.controllers'));
    beforeEach(module('appCatalog.services'));

    beforeEach(inject(function($controller,$rootScope,$httpBackend,App) {
        scope = $rootScope.$new();
        $httpBackend.when('GET', '/entry?id=test').respond({test: 'test response'});
        $httpBackend.when('GET', '/entry').respond([{test: 'test response'}]);
        app = App;
        detailsCtrl = $controller('DetailsCtrl', {$scope: scope, 
            $routeParams: {appId: 'test'}, 
            App: app});
        listCtrl = $controller('ListCtrl', {$scope: scope, 
            App: app});
    }));

    it('should load', function() {
        expect(detailsCtrl).toBeDefined();
        expect(listCtrl).toBeDefined();
    });
});

describe('services', function() {
    beforeEach(module('appCatalog.services'));

    beforeEach(inject(function($rootScope,$httpBackend,App) {
        scope = $rootScope.$new();
        app = App;
        httpB = $httpBackend;
        httpB.when('GET', '/entry?id=test').respond({test: 'test response'});
    }));

    it('should make a query', function() {
        httpB.expectGET('/entry?id=test');
        app.get({id:'test'},function(resp) {
        });
        httpB.flush();
    });

});

describe('directives', function() {

  beforeEach(module('appCatalog.directives'));

  beforeEach(module('tpl/updates.html'));

  beforeEach(module('tpl/media.html'));

  beforeEach(module('tpl/mediaContent.html'));

  describe('apptitle', function() {
    var elm, scope;

    beforeEach(inject(function($rootScope, $compile) {
      scope = $rootScope.$new();
      elm = angular.element("<apptitle src='testapp.titleSection'>");
      $compile(elm)(scope);
      scope.testapp = sample_data;
      scope.$digest();
    }));

    it('should bind its content', function() {
      var titles = elm.find('h1.title');
      var summary = elm.find('div.summary');

      expect(titles.eq(0).text()).toBe(sample_data.titleSection.name);
      expect(summary.eq(0).text()).toBe(sample_data.titleSection.shortDescription);
    });
  });

  describe('description', function() {
    var elm, scope;

    beforeEach(inject(function($rootScope, $compile) {
      scope = $rootScope.$new();
      elm = angular.element("<description src='testapp.descriptionSection'>");
      $compile(elm)(scope);
      scope.testapp = sample_data;
      scope.$digest();
    }));

    it('should bind its content', function() {
      var desc = elm.find('.ng-binding');
      expect(desc.eq(0).text().length).toBeGreaterThan(100);
    });

    it('should render Markdown as html', function() {
        expect(elm.html()).toContain('<strong>');
    });

    it('should exclude forbidden tags from its content', function() {
        expect(elm.html()).not.toContain('<script>'); 
    });

    it('should handle empty data', function($compile) {
      var empty = {descriptionSection: {test: 'Test'}};  

      scope.testapp = empty;
      scope.$digest();

      var text = elm.find('div.markdown');
      expect(text.html()).toBe('');
    });
  });

  describe('textlinks', function() {
    var elm, scope;

    beforeEach(inject(function($rootScope, $compile) {
      scope = $rootScope.$new();
      elm = angular.element("<textlinks src='testapp.linksSection'>");
      $compile(elm)(scope);
      scope.testapp = sample_data;
      scope.$digest();
    }));

    it('should have the right number of entries', function() {
      var items = elm.find('li');
      expect(items.length).toBe(sample_data.linksSection.length);
     });

    it('should allow multiple entries of the same type', function() {
      var images = elm.find('img');
      expect(images.eq(0).attr('ng-src')).toBe(images.eq(1).attr('ng-src'));
    });

    it('should use the default icon for unknown types', function() {
      var images = elm.find('img');
      expect(images.eq(5).attr('ng-src')).toBe('img/hypelink.png');
    });
  });

  describe('updates', function() {
    var elm, scope;

    beforeEach(inject(function($rootScope, $compile) {
      elm = angular.element("<updates src='testapp.updatesSection' />");

      scope = $rootScope;
      $compile(elm)(scope);
      scope.testapp = sample_data;
      scope.$digest();
    }));

    it('should have the correct number of entries initially', function() {
        var updates = elm.find('div.update');
        expect(updates.length).toBe(3);
    });

    it('should have the correct number of entries expanded', function() {
        elm.scope().toggleUpdateList();
        expect(elm.scope().visibleUpdates).toBe(sample_data.updatesSection.updates.length);
    });

    it('should have the correct number of entries collapsed', function() {
        elm.scope().toggleUpdateList();
        elm.scope().toggleUpdateList();
        expect(elm.scope().visibleUpdates).toBe(3);
    });

    it('should be in order by date (newest to oldest)', function() {
        var updates = elm.find('div.version');

        expect(updates.eq(0).text()).toBe(sample_data.updatesSection.updates[1].version);
        expect(updates.eq(1).text()).toBe(sample_data.updatesSection.updates[0].version);
    });

    it('should have correct descriptions', function() {
      var descriptions = elm.find('p');
      expect(descriptions.eq(0).text()).toBe(sample_data.updatesSection.updates[1].description);
    });


    it('should handle empty data', function($compile) {
      var empty = {updatesSection: {updates: [{test: 'Test'}]}};  

      scope.testapp = empty;
      scope.$digest();
      var text = elm.find('p.markdown');
      expect(text.html()).toBe('');
    });
  });

  describe('mediaContent', function() {
    var elm, scope;
 
    beforeEach(inject(function($rootScope, $compile) {
      scope = $rootScope;
      elm = angular.element("<mediaContent src='test'>");
      $compile(elm)(scope);
      scope.test = sample_data.mediaSection[2];
      scope.$digest();
    }));

    it('should know what type of media it has', function() {
        expect(elm.scope().isVideo()).toBe(true);
    });

  });

  describe('media', function() {
    var elm, scope;

    beforeEach(inject(function($rootScope, $compile) {
      scope = $rootScope;
      elm = angular.element("<media src='testapp.mediaSection'>");
      $compile(elm)(scope);
      scope.testapp = sample_data;
      scope.$digest();
    }));

    it('should have the correct number of slides', function() {
      var slides = elm.find('slide');
      expect(slides.length).toBe(3);
    });

    it('does not use a carousel when there is only one item', function() {
      scope.testapp = sample_data_one_slide;
      scope.$digest();
      expect(elm.find('slide').length).toBe(0);
    });   

    it('should use the correct display type for each slide', function() {
      var slides = elm.find('slide');
      expect(slides.eq(1).find('img').length).toBe(1);
      expect(slides.eq(1).find('video').length).toBe(0);
      expect(slides.eq(2).find('img').length).toBe(0);
      expect(slides.eq(2).find('video').length).toBe(1);      
    });

    it('should suppress items with unknown types', function() {
      var count1 = elm.find('slide').length;
      var test_item_1 = {
            "title": "Home",
            "caption": "The home image",
            "mimetype": "image/png",
            "href": "content/gallery/Projekt_es_Projekt_portfolio_menedzsment_ca_clarity_ppm_masolata.jpg",
            "thumbhref": "content/gallery/Projekt_es_Projekt_portfolio_menedzsment_ca_clarity_ppm_masolata.jpg"
        };
      var test_item_2 = {
            "title": "Home",
            "caption": "The home image",
            "mimetype": "foo/bar",
            "href": "content/gallery/Projekt_es_Projekt_portfolio_menedzsment_ca_clarity_ppm_masolata.jpg",
            "thumbhref": "content/gallery/Projekt_es_Projekt_portfolio_menedzsment_ca_clarity_ppm_masolata.jpg"
        };
      scope.testapp.mediaSection.push(test_item_1);
      scope.$digest();
      var count2 = elm.find('slide').length;
      scope.testapp.mediaSection.push(test_item_2);
      scope.$digest();
      var count3 = elm.find('slide').length;

      expect(count2).toBe(count1 + 1);
      expect(count3).toBe(count2);
    });

    it('displays captions for slides that have them', function() {
      var captions = elm.find('.caption');
      expect(captions.eq(0).text()).toBe(sample_data.mediaSection[0].caption);
    });

    it('hides the caption area if no caption is set', function() {
      var captions = elm.find('.carousel-caption');

      expect(captions.eq(1).css('display')).toBe('none');

    });

    it('uses the correct poster image for videos', function() {
      var posters = elm.find('video');
      expect(posters.eq(0).attr('poster')).toBe(sample_data.mediaSection[2].thumbhref);
    });

  });
});
